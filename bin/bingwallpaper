#!/usr/bin/env ruby
#-*- mode: enh-ruby;-*-

#
# Sets the desktop wallpaper to the current "image of the day" from the Bing
# search engine.
#
require "bingwallpaper"
require "logger"

# setup a logger
logger = Logger.new(STDOUT)
logger.formatter = proc do |severity, time, progname, msg|
  "%-6s %s\n" % [severity, msg]
end

# create an instance and set the wallpaper
bingImage = Bingwallpaper::Image.new

begin

  # compute the URL for the image of the data data
  data_url = bingImage.get_data_url

  # parse image of the day data
  image_data = bingImage.parse_xml data_url

  # decide where we'll save today's image
  image_path = bingImage.image_storage_path image_data[0][:file_name]
  fallback_image_path = bingImage.image_storage_path image_data[0][:fallback_file_name]

  # try the hi-res image
  if !image_path.exist?

    begin

      bingImage.download_image image_path, image_data[0][:links][:url]
    rescue Exception => exception
      logger.info "I couldn't download the hi-resolution image of the day..."
      logger.info "I couldn't load " + image_data[0][:links][:url]
    end
  end


  # fallback to the low-res image
  if !image_path.exist? && !fallback_image_path.exist?

    begin

      bingImage.download_image fallback_image_path, image_data[0][:links][:fallback_url]
    rescue Exception => exception
      logger.info "I couldn't download the low-resolution image of the day..."
      logger.info "I couldn't load " + image_data[0][:links][:url]
    end
  end

  # set the wallpaper
  if image_path.exist?

    # set the wallpaper
    logger.info "Wallpaper set to #{image_path}"
    `feh --bg-fill #{image_path}`
  elsif fallback_image_path.exist?

    # set the wallpaper
    logger.info "Only the low-resolution image was available today."
    logger.info "Wallpaper set to #{image_path}"
    `feh --bg-fill #{fallback_image_path}`
  else

    logger.info "Sorry, I couldn't download the Bing Image of the Day. :'("
  end
rescue Exception => exception
  logger.info "Sorry, I couldn't set today's Bing Image of the Day Wallpaper. :'("
  logger.error "The problems was: " + exception.message
  exit 1
end
